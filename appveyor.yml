version: 1.1.2.{build}
assembly_info:
  patch: true
  file: AssemblyInfo.cs
  assembly_version: '{version}'
  assembly_file_version: '{version}'
  assembly_informational_version: '{version}-rc1'
artifacts:
  - path: build\artifacts\*.update
    name: Sitecore.Lighthouse
before_build:
  - nuget sources add -Name SitecorePublicFeed -Source https://sitecore.myget.org/F/sc-packages/api/v3/index.json
  - nuget sources add -Name SitecorePublicFeed2 -Source https://sitecore.myget.org/gallery/sc-packages
  - nuget restore Sitecore.Lighthouse.sln
  - SonarScanner.MSBuild.exe begin /k:"Sitecore.Lighthouse" /d:"sonar.host.url=https://sonarcloud.io" /d:"sonar.login=%sonar_token%" /n:"Sitecore.Lighthouse" /o:"antonytm-github" /d:"sonar.exclusions=Models/Autogenerated/**"
build:
  project: Sitecore.Lighthouse.sln
after_build:
  - SonarScanner.MSBuild.exe end /d:"sonar.login=%sonar_token%"
  - ps: .\build\build.ps1  
environment:
  matrix:
    - JAVA_HOME: C:\Program Files\Java\jdk13
  sonar_token:
    secure: xT1FpsQcLjyehwDNkphemCQZOGIgPm8asR0BMqYtaG3+3u5FhFqFTm2QOBGaRzvY
deploy:
  release: Sitecore.Lighthouse-v$(appveyor_build_version)
  description: 'Google Lighthouse in Sitecore'
  provider: GitHub
  auth_token:
    secure: rkLSxUbN2YMMG/r6lzLq1PN0n07dqJBtk/8ZR2c/InGy0SBOsmqGXfIQWMQOZUAs 
  draft: false
  prerelease: false
  on:
    branch: master                # release from master branch only
    appveyor_repo_tag: true       # deploy on tag push only
install:
  - ps: Install-Module -Name Sitecore.Courier -Force
  - ps: Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
  - choco install sitecore-courier
  - choco install "msbuild-sonarqube-runner" -y
  - cd "lighthouse tools"
  - ps: npm install
  - cd ..
